<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Scan to PDF ‚Äì PDF Chamber</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- CropperJS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet"/>

<!-- Libraries (loaded before use) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
/* ---------------- THEME & LAYOUT - KEEPED AS YOUR ORIGINAL ---------------- */
:root{
  --focus: #00AEEF;
  --accent: #00c6d8;
  --header-bg:#0a8b65;
  --card-bg:#ffffff;
  --text-primary:#002B5B;
  --text-secondary:#455A64;
  --shadow:rgba(0,0,0,0.08);
  --footer-bg:#0a8b65;
  --footer-text:#ECEFF1;
  --qr-color: #00c6d8;
  --feature-hover-glow: rgba(0,174,255,0.4);
}
[data-theme="dark"]{
  --header-bg:#0a8b65;
  --card-bg:#1B263B;
  --text-primary:#E0E1DD;
  --text-secondary:#778DA9;
  --footer-text:#E0E1DD;
}

*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Inter',system-ui,sans-serif;-webkit-font-smoothing:antialiased;}
body{display:flex;flex-direction:column;min-height:100vh;background:linear-gradient(135deg,#aef1fc 0%,#E3F2FD 50%,#90CAF9 100%);color:var(--text-primary);}

/* Header */
header{
  background:var(--header-bg);
  padding:1rem 5%;
  box-shadow:0 4px 20px var(--shadow);
  position:fixed;top:0;width:100%;z-index:1000;
}
.header-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:1rem}
.logo{display:flex;align-items:center;gap:.75rem;font-weight:700;font-size:1.8rem;color:#fff;text-decoration:none;}
.logo svg{width:48px;height:48px;fill:#fff;}
.tagline{font-size:.95rem;color:#E2E8F0;font-weight:500;}
.theme-toggle{width:56px;height:30px;background:rgba(255,255,255,0.2);border:2px solid #fff;border-radius:50px;position:relative;cursor:pointer;}
.theme-toggle::before{content:'';position:absolute;top:3px;left:4px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .3s ease,background .3s ease;}
[data-theme="dark"] .theme-toggle::before{transform:translateX(24px);background:#1B263B;}

/* Main & QR */
main{margin-top:90px;flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:1rem 1rem 3rem;text-align:center;overflow:auto;}
h2{font-size:2.6rem;font-weight:700;background:linear-gradient(90deg,#74ea00,#00AEEF);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.75rem;}
.subtext{font-size:1.4rem;color:var(--header-bg);margin-bottom:2rem;font-weight:600;}

.qr-section{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:55vh;width:100%;}
.qr-box{background:var(--card-bg);border:3px solid #005f99;padding:2rem;border-radius:18px;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;box-shadow:0 0 25px rgba(0,95,153,0.4),0 0 40px rgba(0,95,153,0.2);animation:glowPulse 4s ease-in-out infinite;}
.qr-box::before{content:'';position:absolute;inset:0;border-radius:18px;border:2px solid var(--qr-color);box-shadow:0 0 20px var(--qr-color),inset 0 0 15px rgba(0,198,216,0.5);opacity:0.9;z-index:0;}
.qr-box img{width:220px;height:220px;position:relative;z-index:1;}

@keyframes glowPulse{0%,100%{box-shadow:0 0 20px var(--qr-color);}50%{box-shadow:0 0 35px var(--qr-color);}}

/* Features */
.features{display:flex;justify-content:center;align-items:stretch;gap:2rem;margin-top:3rem;width:95%;max-width:1400px;flex-wrap:wrap;}
.feature-card{flex:1;background:var(--card-bg);border-radius:16px;box-shadow:0 8px 30px var(--shadow);border:2px solid #005f99;padding:2.5rem;min-width:300px;max-width:400px;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:transform .28s ease,box-shadow .28s ease,border-color .28s ease;}
.feature-card h3{color:#005f99;font-size:1.35rem;font-weight:700;margin-bottom:.5rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.feature-card p{color:var(--text-secondary);font-size:1.05rem;text-align:center;line-height:1.5;}
.feature-card:hover{transform:translateY(-8px) scale(1.02);border-color:var(--accent);box-shadow:0 0 25px var(--accent),0 0 45px rgba(0,198,216,0.35)}

/* Footer */
footer{margin-top:auto;background:var(--footer-bg);color:var(--footer-text);padding:2rem 5%;text-align:center;font-size:.9rem;}
.footer-links{margin-bottom:.75rem;}
.footer-links a{color:#fff;margin:0 1rem;font-weight:500;text-decoration:underline;}

/* ---------------- Mobile Scanner UI (scoped & hidden on desktop) ---------------- */
.scanner-root{display:none;width:100%;max-width:1000px;margin:0 auto;padding:12px;box-sizing:border-box;}
.camera-wrap{position:relative;border-radius:14px;overflow:hidden;background:#000;box-shadow:0 6px 30px rgba(0,0,0,0.6);margin-bottom:12px;max-width:780px}
video#preview{width:100%;height:calc(100vw - 48px);object-fit:cover;max-height:740px}
canvas#captureCanvas{display:none}
.overlay-rect{position:absolute;inset:0;pointer-events:none}
.edge-rect{position:absolute;border:2.5px solid var(--accent);box-shadow:0 0 18px var(--accent);border-radius:6px;mix-blend-mode:screen;pointer-events:none}
.crop-layer{position:absolute;inset:0;pointer-events:auto}
.corner{position:absolute;width:28px;height:28px;border-radius:6px;background:var(--accent);transform:translate(-50%,-50%);box-shadow:0 6px 18px rgba(0,216,198,0.25);touch-action:none}

/* Controls and thumbnails */
.controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.btn{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);padding:10px 12px;border-radius:10px;color:var(--text-primary);font-weight:600;font-size:14px}
.btn.primary{background:linear-gradient(90deg,var(--accent),#2ddfc9);color:#012;box-shadow:0 6px 22px rgba(0,216,198,0.12)}
.btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.06)}
.pages{display:flex;gap:8px;overflow:auto;padding:6px}
.page-thumb{width:76px;height:100px;border-radius:8px;overflow:hidden;background:#061018;border:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;flex-shrink:0;position:relative}
.page-thumb img{width:100%;height:100%;object-fit:cover}
.thumb-controls{position:absolute;right:6px;top:6px;display:flex;flex-direction:column;gap:6px}

/* Cropper modal */
#cropperModal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:3000;align-items:center;justify-content:center;padding:12px}
#cropperModal .modal{width:100%;max-width:920px;background:#fff;border-radius:10px;overflow:hidden}
#cropperImage{max-width:100%;display:block;background:#000;padding:6px}

/* Responsive: show scanner on small widths */
@media (max-width:900px){
  .scanner-root{display:block}
  #desktopMain, #featuresSection{display:none}
  main{padding:0;margin-top:72px}
}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <a href="index.html" class="logo">
      <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 .9 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
      PDF Chamber
    </a>
    <div style="display:flex;align-items:center;gap:1rem;">
      <div class="tagline">Smart PDFs, Seamless Productivity</div>
      <button class="theme-toggle" id="themeToggle" title="Toggle theme"></button>
    </div>
  </div>
</header>

<main>
  <!-- Desktop: QR + features -->
  <section id="desktopMain" class="qr-section">
    <h2>Scan to PDF</h2>
    <div class="subtext">Scan this QR code using your mobile device to open the Scan to PDF tool.</div>
    <div class="qr-box">
      <img id="qrImg" src="https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=https://example.com/scan-to-pdf.html&color=00c6d8" alt="Scan QR">
    </div>
  </section>

  <section id="featuresSection" class="features" aria-label="features">
    <div class="feature-card"><h3>üì∏ Instant Scanning</h3><p>Capture documents or notes using your camera and convert them into high-quality PDFs.</p></div>
    <div class="feature-card"><h3>üß† Smart Auto-Crop</h3><p>Automatically detect document edges and crop them perfectly for a clean, professional look.</p></div>
    <div class="feature-card"><h3>‚òÅÔ∏è Share Easily</h3><p>Download or share your PDF instantly ‚Äî seamless, secure, and always accessible.</p></div>
  </section>

  <!-- Mobile: scanner UI (hidden on desktop unless JS toggles) -->
  <section id="mobileScanner" class="scanner-root hidden" aria-hidden="true">
    <div class="camera-wrap" id="cameraWrap">
      <video id="preview" autoplay playsinline></video>
      <canvas id="captureCanvas"></canvas>
      <div class="overlay-rect"><div id="detectedRect" class="edge-rect" style="display:none"></div></div>
      <div id="cropLayer" class="crop-layer" hidden>
        <div id="h1" class="corner" data-corner="tl"></div>
        <div id="h2" class="corner" data-corner="tr"></div>
        <div id="h3" class="corner" data-corner="br"></div>
        <div id="h4" class="corner" data-corner="bl"></div>
      </div>
    </div>

    <div class="controls" style="align-items:center">
      <button id="snapBtn" class="btn primary">Capture</button>
      <button id="uploadBtn" class="btn">Upload</button>
      <input id="fileInput" type="file" accept="image/*" style="display:none" multiple>

      <div style="display:flex;gap:8px;align-items:center;margin-left:auto">
        <label style="font-size:12px;color:var(--text-secondary)">Doc</label>
        <select id="paperSelect" class="btn ghost">
          <option value="a4">A4</option><option value="letter">Letter</option><option value="legal">Legal</option><option value="square">Square</option>
        </select>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;overflow:auto;margin-top:10px">
      <div>
        <label class="small" style="color:var(--text-secondary)">Filter</label>
        <select id="filterSelect" class="btn ghost"><option value="none">None</option><option value="bw">B/W</option><option value="gray">Gray</option><option value="sepia">Sepia</option><option value="hd">HD</option></select>
      </div>
      <div>
        <label class="small" style="color:var(--text-secondary)">Brightness</label>
        <input id="brightness" class="slider" type="range" min="-60" max="60" value="0">
      </div>
      <div>
        <label class="small" style="color:var(--text-secondary)">Contrast</label>
        <input id="contrast" class="slider" type="range" min="-60" max="60" value="0">
      </div>

      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="addPageBtn" class="btn">Add page</button>
        <button id="downloadBtn" class="btn primary">Download PDF</button>
        <button id="shareBtn" class="btn">Share</button>
      </div>
    </div>

    <div class="pages" id="pages" style="margin-top:10px"></div>

    <footer style="margin-top:12px;background:transparent;padding:12px">
      <div style="color:var(--text-secondary)">Supports JPG, PNG, HEIC*, WebP - high-quality captures</div>
      <div style="font-size:12px;color:var(--text-secondary)">*HEIC support depends on browser</div>
    </footer>
  </section>
</main>

<footer>
  <div class="footer-links">
    <a href="#">About</a>
    <a href="#">Privacy</a>
    <a href="#">Terms</a>
    <a href="#">Support</a>
  </div>
  <div>¬© 2025 PDF Chamber. All rights reserved.</div>
</footer>

<!-- Cropper modal -->
<div id="cropperModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:4000;align-items:center;justify-content:center;padding:16px">
  <div style="width:100%;max-width:920px;background:#fff;border-radius:10px;overflow:hidden">
    <div style="padding:10px;display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:700">Edit & Adjust</div>
      <div>
        <button id="cropCancel" class="btn">Cancel</button>
        <button id="cropApply" class="btn primary">Apply</button>
      </div>
    </div>
    <div style="background:#000;padding:12px;display:flex;justify-content:center">
      <img id="cropperImage" alt="crop source" style="max-width:100%;display:block">
    </div>
    <div style="display:flex;gap:8px;padding:10px;justify-content:center;align-items:center">
      <label style="font-size:13px;color:#333">Brightness</label>
      <input id="cropBrightness" type="range" min="-60" max="60" value="0" style="width:160px">
      <label style="font-size:13px;color:#333">Contrast</label>
      <input id="cropContrast" type="range" min="-60" max="60" value="0" style="width:160px">
      <select id="cropFilter" class="btn ghost" style="padding:6px 8px">
        <option value="none">None</option><option value="bw">B/W</option><option value="gray">Gray</option><option value="sepia">Sepia</option><option value="hd">HD</option>
      </select>
    </div>
  </div>
</div>

<script>
/* ---------------------------
  Theme toggle
---------------------------- */
const themeToggle = document.getElementById('themeToggle');
const setTheme = t => document.documentElement.setAttribute('data-theme', t);
setTheme(localStorage.getItem('theme') || 'light');
themeToggle.addEventListener('click', () => {
  const newTheme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
  setTheme(newTheme);
  localStorage.setItem('theme', newTheme);
});

/* ---------------------------
  DOM refs
---------------------------- */
const desktopMain = document.getElementById('desktopMain');
const featuresSection = document.getElementById('featuresSection');
const mobileScanner = document.getElementById('mobileScanner');

const preview = document.getElementById('preview');
const captureCanvas = document.getElementById('captureCanvas');
const snapBtn = document.getElementById('snapBtn');
const fileInput = document.getElementById('fileInput');
const uploadBtn = document.getElementById('uploadBtn');
const pagesEl = document.getElementById('pages');
const filterSelect = document.getElementById('filterSelect');
const brightness = document.getElementById('brightness');
const contrast = document.getElementById('contrast');
const addPageBtn = document.getElementById('addPageBtn');
const downloadBtn = document.getElementById('downloadBtn');
const shareBtn = document.getElementById('shareBtn');
const paperSelect = document.getElementById('paperSelect');

const cropperModal = document.getElementById('cropperModal');
const cropperImage = document.getElementById('cropperImage');
const cropApply = document.getElementById('cropApply');
const cropCancel = document.getElementById('cropCancel');
const cropBrightness = document.getElementById('cropBrightness');
const cropContrast = document.getElementById('cropContrast');
const cropFilter = document.getElementById('cropFilter');

/* ---------------------------
  State
---------------------------- */
let stream = null;
let cameraStarted = false;
let pages = []; // {dataUrl,w,h}
let cropperInstance = null;
let editingIndex = null;

/* ---------------------------
  Helpers
---------------------------- */
const isMobile = () => /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth <= 900;
function toDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function loadImage(src){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; img.crossOrigin='anonymous'; }); }

/* ---------------------------
  Switch view
---------------------------- */
function switchView(){
  if(isMobile()){
    desktopMain.classList.add('hidden');
    featuresSection.classList.add('hidden');
    mobileScanner.classList.remove('hidden');
    mobileScanner.setAttribute('aria-hidden','false');
    startCamera();
  } else {
    desktopMain.classList.remove('hidden');
    featuresSection.classList.remove('hidden');
    mobileScanner.classList.add('hidden');
    mobileScanner.setAttribute('aria-hidden','true');
    stopCamera();
  }
}
window.addEventListener('resize', switchView);
document.addEventListener('DOMContentLoaded', () => {
  // update QR to current location
  try{ document.getElementById('qrImg').src = 'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=' + encodeURIComponent(window.location.href) + '&color=00c6d8'; }catch(e){}
  switchView();
});

/* ---------------------------
  Camera start/stop + simple detection
---------------------------- */
async function startCamera(){
  if(cameraStarted) return;
  try{
    const constraints = { video: { facingMode: { ideal: 'environment' }, width: { ideal: 1920 }, height: { ideal: 1440 } }, audio:false };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    preview.srcObject = stream;
    await preview.play();
    cameraStarted = true;
    detectLoopStart();
  }catch(e){
    console.warn('camera failed', e);
  }
}
function stopCamera(){
  if(stream){ try{ stream.getTracks().forEach(t=>t.stop()); }catch(e){} stream = null; }
  cameraStarted = false;
  detectLoopStop();
}

/* Lightweight document presence heuristic (not full deskew) */
let detectTimer = null;
function detectLoopStart(){ if(detectTimer) return; detectTimer = setInterval(()=>{ try{ detectDocument(); }catch(e){} }, 600); }
function detectLoopStop(){ if(!detectTimer) return; clearInterval(detectTimer); detectTimer = null; }

function detectDocument(){
  if(preview.readyState < 2) return;
  const w = preview.videoWidth || preview.clientWidth;
  const h = preview.videoHeight || preview.clientHeight;
  const tmp = document.createElement('canvas'); tmp.width = 240; tmp.height = Math.round(240*h/w);
  const tctx = tmp.getContext('2d'); tctx.drawImage(preview,0,0,tmp.width,tmp.height);
  const imgd = tctx.getImageData(0,0,tmp.width,tmp.height).data;
  let sum=0,sumSq=0,n=0;
  for(let i=0;i<imgd.length;i+=4){ const lum=0.3*imgd[i]+0.59*imgd[i+1]+0.11*imgd[i+2]; sum+=lum; sumSq+=lum*lum; n++; }
  const mean=sum/n; const variance=(sumSq/n - mean*mean);
  const rect = document.getElementById('detectedRect');
  if(variance > 400) rect.style.display='block'; else rect.style.display='none';
}

/* ---------------------------
  Capture & Crop flow
---------------------------- */
snapBtn.addEventListener('click', async ()=>{
  if(preview.readyState < 2) return;
  const vw = preview.videoWidth || preview.clientWidth;
  const vh = preview.videoHeight || preview.clientHeight;
  captureCanvas.width = vw; captureCanvas.height = vh;
  const ctx = captureCanvas.getContext('2d');
  ctx.drawImage(preview,0,0,vw,vh);
  const dataUrl = captureCanvas.toDataURL('image/jpeg', 0.95);
  openCropperModal(dataUrl, true);
});

/* Upload */
uploadBtn.addEventListener('click', ()=> fileInput.click());
fileInput.addEventListener('change', async (ev)=>{
  const files = Array.from(ev.target.files);
  for(const f of files){
    if(!f.type.startsWith('image/')) continue;
    const dataUrl = await toDataURL(f);
    openCropperModal(dataUrl, true);
  }
  fileInput.value = '';
});

/* Cropper modal functions */
function openCropperModal(src, pushAfterApply=true){
  cropperModal.style.display = 'flex';
  cropperImage.src = src;
  cropBrightness.value = 0; cropContrast.value = 0; cropFilter.value = 'none';
  cropperImage.onload = () => {
    if(cropperInstance){ try{ cropperInstance.destroy(); }catch(e){} cropperInstance=null; }
    cropperInstance = new Cropper(cropperImage, { viewMode:1, autoCropArea:0.95, movable:true, zoomable:true, rotatable:false });
  };
  cropCancel.onclick = ()=>{
    cropperModal.style.display='none';
    try{ cropperInstance.destroy(); }catch(e){} cropperInstance=null;
    editingIndex = null;
  };
  cropApply.onclick = ()=>{
    try{
      const cropCanvas = cropperInstance.getCroppedCanvas({ imageSmoothingQuality:'high' });
      const ctx = cropCanvas.getContext('2d');
      let imgd = ctx.getImageData(0,0,cropCanvas.width,cropCanvas.height);
      applyBrightnessContrast(imgd, parseInt(cropBrightness.value), parseInt(cropContrast.value));
      applyFilter(imgd, cropFilter.value);
      ctx.putImageData(imgd,0,0);
      const finalUrl = cropCanvas.toDataURL('image/jpeg', 0.95);
      if(editingIndex === null) pages.push({ dataUrl: finalUrl, w: cropCanvas.width, h: cropCanvas.height });
      else pages[editingIndex] = { dataUrl: finalUrl, w: cropCanvas.width, h: cropCanvas.height };
      renderPages();
    }catch(e){ console.error('apply crop error', e); }
    cropperModal.style.display='none';
    try{ cropperInstance.destroy(); }catch(e){} cropperInstance=null;
    editingIndex = null;
  };
}

/* Adjustments */
function applyBrightnessContrast(imgd, brightnessValue, contrastValue){
  const data = imgd.data; const b = brightnessValue | 0; const c = contrastValue/100;
  const factor = (259*(c*255+255))/(255*(259 - c*255));
  for(let i=0;i<data.length;i+=4){
    for(let j=0;j<3;j++){
      let v = data[i+j];
      v = v + b;
      v = factor * (v - 128) + 128;
      data[i+j] = Math.max(0,Math.min(255,Math.round(v)));
    }
  }
}
function applyFilter(imgd, filter){
  const data = imgd.data; const len = data.length;
  if(filter === 'none') return;
  if(filter === 'gray' || filter === 'bw'){
    for(let i=0;i<len;i+=4){ const avg = Math.round(0.3*data[i]+0.59*data[i+1]+0.11*data[i+2]); data[i]=data[i+1]=data[i+2]=avg; }
    if(filter === 'bw') for(let i=0;i<len;i+=4){ const v=data[i]; const out = v>120?255:0; data[i]=data[i+1]=data[i+2]=out; }
  } else if(filter === 'sepia'){
    for(let i=0;i<len;i+=4){ const r=data[i], g=data[i+1], b=data[i+2]; data[i]=Math.min(255,Math.round(r*0.393+g*0.769+b*0.189)); data[i+1]=Math.min(255,Math.round(r*0.349+g*0.686+b*0.168)); data[i+2]=Math.min(255,Math.round(r*0.272+g*0.534+b*0.131)); }
  } else if(filter === 'hd'){
    const w = imgd.width, h = imgd.height; const copy = new Uint8ClampedArray(data);
    for(let y=1;y<h-1;y++){ for(let x=1;x<w-1;x++){ const i=(y*w+x)*4; for(let c=0;c<3;c++){ const blurred=(copy[i-4+c]+copy[i+4+c]+copy[i-4*w+c]+copy[i+4*w+c]+copy[i+c])/5; const diff=copy[i+c]-blurred; let nv = copy[i+c] + diff*0.85; data[i+c]=Math.max(0,Math.min(255,nv)); } } }
  }
}

/* ---------------------------
  Thumbnail render & edit/delete
---------------------------- */
function renderPages(){
  pagesEl.innerHTML = '';
  pages.forEach((p, idx)=>{
    const div = document.createElement('div'); div.className='page-thumb';
    const img = document.createElement('img'); img.src = p.dataUrl; div.appendChild(img);
    const ctrl = document.createElement('div'); ctrl.className='thumb-controls';
    const edit = document.createElement('button'); edit.className='btn'; edit.textContent='‚úé'; edit.title='Edit';
    const del = document.createElement('button'); del.className='btn'; del.textContent='üóë'; del.title='Delete';
    edit.onclick = ()=>{ editingIndex = idx; openCropperModal(pages[idx].dataUrl, false); };
    del.onclick = ()=>{ pages.splice(idx,1); renderPages(); };
    ctrl.appendChild(edit); ctrl.appendChild(del);
    div.appendChild(ctrl);
    pagesEl.appendChild(div);
  });
}

/* Add page button alias */
addPageBtn.addEventListener('click', ()=> snapBtn.click());

/* ---------------------------
  PDF generation with pdf-lib
---------------------------- */
downloadBtn.addEventListener('click', async ()=>{
  if(pages.length === 0){ alert('No pages'); return; }
  const pdfDoc = await PDFLib.PDFDocument.create();
  for(let i=0;i<pages.length;i++){
    const p = pages[i];
    const img = await loadImage(p.dataUrl);
    const imgBytes = await (await fetch(p.dataUrl)).arrayBuffer();
    const ext = p.dataUrl.indexOf('png')>-1 ? 'png' : 'jpg';
    let embedded;
    try {
      embedded = ext === 'png' ? await pdfDoc.embedPng(imgBytes) : await pdfDoc.embedJpg(imgBytes);
    } catch(e){
      embedded = await pdfDoc.embedJpg(imgBytes);
    }
    const page = pdfDoc.addPage([embedded.width, embedded.height]);
    page.drawImage(embedded, { x: 0, y: 0, width: embedded.width, height: embedded.height });
  }
  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes], { type: 'application/pdf' });
  saveAs(blob, 'scans.pdf');
});

/* Share: use Web Share if available else fallback to download */
shareBtn.addEventListener('click', async ()=>{
  if(pages.length === 0){ alert('No pages to share'); return; }
  const pdfDoc = await PDFLib.PDFDocument.create();
  for(let i=0;i<pages.length;i++){
    const p = pages[i];
    const imgBytes = await (await fetch(p.dataUrl)).arrayBuffer();
    const ext = p.dataUrl.indexOf('png')>-1 ? 'png' : 'jpg';
    let embedded;
    try { embedded = ext === 'png' ? await pdfDoc.embedPng(imgBytes) : await pdfDoc.embedJpg(imgBytes); }
    catch(e){ embedded = await pdfDoc.embedJpg(imgBytes); }
    const page = pdfDoc.addPage([embedded.width, embedded.height]);
    page.drawImage(embedded, { x: 0, y: 0, width: embedded.width, height: embedded.height });
  }
  const pdfBytes = await pdfDoc.save();
  const file = new File([pdfBytes], 'scans.pdf', { type: 'application/pdf' });
  try {
    if(navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({ files: [file], title:'Scanned document', text:'Scanned using PDF Chamber' });
      return;
    }
  } catch(e){}
  saveAs(new Blob([pdfBytes], { type:'application/pdf' }), 'scans.pdf');
});

/* ---------------------------
  Cleanup on hide
---------------------------- */
window.addEventListener('pagehide', ()=>{ stopCamera(); });

</script>
</body>
</html>
