<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Scan to PDF — PDF Chamber</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<!-- CDNs -->
<script src="https://docs.opencv.org/4.7.0/opencv.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/sortablejs@1.15.0/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

<style>
:root{
  --focus:#00AEEF;--transition:all .3s ease;
  --bg-gradient:linear-gradient(135deg,#E3F2FD 0%,#BBDEFB 50%,#90CAF9 100%);
  --header-bg:#0a8b65; --card-bg:#fff; --text-primary:#002B5B; --text-secondary:#455A64;
  --btn-green:#0a8b65; --btn-hover:#087555; --footer-bg:#0a8b65; --footer-text:#ECEFF1;
}
[data-theme="dark"]{
  --bg-gradient:linear-gradient(135deg,#0D1B2A 0%,#1B263B 50%,#415A77 100%);
  --card-bg:#1B263B; --text-primary:#E0E1DD; --text-secondary:#AAB4BE;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Inter',sans-serif;
  background:var(--bg-gradient);
  color:var(--text-primary);
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

/* Header matches merge-pdf.html */
header{
  background:var(--header-bg); color:#fff; padding:1rem 5%; display:flex; justify-content:space-between; align-items:center;
}
.logo{display:flex;align-items:center;gap:.75rem;font-weight:700;font-size:1.8rem;color:#fff;text-decoration:none;}
.logo svg{width:40px;height:40px;fill:#fff;}
.theme-toggle{width:56px;height:30px;background:rgba(255,255,255,.15);border:2px solid #fff;border-radius:50px;position:relative;cursor:pointer}
.theme-toggle::before{content:'';position:absolute;top:3px;left:4px;width:20px;height:20px;background:#fff;border-radius:50%;transition:transform .3s}
[data-theme="dark"] .theme-toggle::before{transform:translateX(24px);background:#1B263B}

/* Main container */
main{flex:1;max-width:1200px;margin:2rem auto;padding:0 5%}
.grid{display:grid;grid-template-columns:1fr 380px;gap:16px;align-items:start}
.card{background:var(--card-bg);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,40,60,.08)}

/* Camera area */
.camera-wrap{position:relative;border-radius:10px;overflow:hidden;background:#000;height:72vh;min-height:420px;display:flex;align-items:center;justify-content:center}
video#cameraView{width:100%;height:100%;object-fit:cover;display:block}
canvas#overlay{position:absolute;left:0;top:0;pointer-events:none;width:100%;height:100%}

/* Controls */
.controls{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.8rem}
.btn{background:var(--btn-green);color:#fff;border:none;padding:.6rem 1rem;border-radius:8px;font-weight:600;cursor:pointer;transition:var(--transition)}
.btn:hover{background:var(--btn-hover);transform:scale(1.03)}
.toggle{padding:.45rem .75rem;border-radius:8px;border:2px solid rgba(0,0,0,.06);background:#fff;cursor:pointer}

/* Filters & sliders */
.filters{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.6rem}
.range{display:flex;gap:8px;align-items:center;margin-top:.6rem}

/* Preview list */
.preview-list{display:flex;flex-direction:column;gap:.5rem;max-height:72vh;overflow:auto}
.thumb{display:flex;align-items:center;gap:.75rem;padding:.5rem;border-radius:8px;background:var(--card-bg);border:1px solid rgba(0,0,0,.05)}
.thumb canvas{width:120px;height:auto;border-radius:6px}
.thumb .meta{font-size:.9rem;color:var(--text-primary)}

/* QR & desktop upload */
.desktop-qr{display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px;text-align:center}
.qr-canvas{width:220px;height:220px;background:#fff;padding:10px;border-radius:8px;box-shadow:0 8px 18px rgba(0,0,0,.08)}
.upload-area{border:2px dashed var(--btn-green);padding:12px;border-radius:10px;text-align:center}

/* Modal cropper */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:60}
.modal.show{display:flex}
.modal .modal-card{background:var(--card-bg);border-radius:10px;width:min(980px,95%);height:min(90vh,90%);padding:12px;display:flex;flex-direction:column;gap:8px}
.img-wrap{flex:1;overflow:auto;display:flex;align-items:center;justify-content:center}

/* Onboarding (Adobe-style light blue) */
.onboard { position: fixed; inset:0; display:none; z-index:1000; align-items:center; justify-content:center; pointer-events:none; }
.onboard.active{ display:flex; pointer-events:auto; }
.onboard-overlay{ position:absolute; inset:0; background: rgba(2,18,34,0.58); }
.onboard-tooltip{ position:absolute; max-width:300px; background:#fff; color:#062739; padding:14px; border-radius:12px; box-shadow:0 8px 40px rgba(0,0,0,.35); transform-origin:top left; }
.onboard-highlight{ position:absolute; border:3px solid #2196F3; border-radius:14px; box-shadow:0 0 30px #2196F3aa; transition:all .35s ease; z-index:1010; }

/* small text */
.small{font-size:.95rem;color:var(--text-secondary);}

/* Footer */
footer{background:var(--footer-bg);color:var(--footer-text);text-align:center;padding:1.25rem 5%;margin-top:16px}

@media(max-width:900px){
  .grid{grid-template-columns:1fr}
  .camera-wrap{height:78vh;min-height:520px}
}
</style>
</head>
<body>
<header>
  <a href="index.html" class="logo">
    <svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/></svg>
    PDF Chamber
  </a>
  <div class="theme-toggle" id="themeToggle" title="Toggle theme"></div>
</header>

<main>
  <div class="grid">
    <!-- Left: camera / mobile scanner (shown on mobile), desktop shows a mini prompt if desired -->
    <section class="card" id="leftCard">
      <!-- Mobile scanner area -->
      <div id="mobileScanner" style="display:none">
        <div class="camera-wrap" id="cameraWrap">
          <video id="cameraView" autoplay playsinline></video>
          <canvas id="overlay"></canvas>
        </div>

        <div class="controls">
          <button class="btn" id="openCameraBtn">Open Camera</button>
          <button class="btn" id="captureBtn" disabled>Capture</button>
          <label class="toggle" id="uploadLabel">Choose Images<input id="fileInput" type="file" accept="image/*" hidden multiple></label>
          <button class="btn" id="autoToggle">Auto-Capture: On</button>
        </div>

        <div class="filters">
          <button class="btn filter-btn active" data-filter="original">Original</button>
          <button class="btn filter-btn" data-filter="auto">Auto Color</button>
          <button class="btn filter-btn" data-filter="light">Light Text</button>
          <button class="btn filter-btn" data-filter="gray">Grayscale</button>
          <button class="btn filter-btn" data-filter="bw">B&W</button>
        </div>

        <div class="range">
          <div class="small">Brightness</div>
          <input id="brightness" type="range" min="50" max="150" value="100">
          <div class="small">Contrast</div>
          <input id="contrast" type="range" min="50" max="150" value="100">
        </div>

        <div style="margin-top:10px">
          <button class="btn" id="generatePdfBtn" disabled>Generate PDF</button>
          <button class="btn" id="downloadBtn" disabled>Download PDF</button>
          <button class="btn" id="shareBtn" disabled>Share PDF</button>
        </div>
      </div>

      <!-- Desktop hint (visible on desktop) -->
      <div id="desktopHint" style="display:none">
        <h2 style="margin-top:0">Scan with your phone</h2>
        <p class="small">Open this page on your mobile device for the full scanner experience. Scan the QR code on the right. You can also drag & drop images below the QR to create a PDF from desktop.</p>

        <div style="margin-top:12px" class="upload-area">
          <p class="small">Drag & drop images here (or use the panel on the right)</p>
          <div style="margin-top:8px"><small class="small">Drop files on this area or on the QR card to upload images.</small></div>
        </div>
      </div>
    </section>

    <!-- Right: pages list + desktop QR + drag-drop -->
    <aside class="card">
      <div id="desktopPanel" style="display:none">
        <div style="display:flex;flex-direction:column;align-items:center">
          <div class="desktop-qr">
            <canvas id="qrCanvas" class="qr-canvas"></canvas>
            <div class="small">Scan with your phone camera</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button class="btn" id="copyLinkBtn">Copy Link</button>
            </div>
          </div>

          <div style="width:100%;margin-top:12px" class="upload-area" id="desktopDropArea">
            <p class="small">Drag & drop images here to upload</p>
            <small class="small">Only image files (JPG/PNG) are accepted.</small>
          </div>
        </div>
      </div>

      <h3 style="margin:12px 0 8px 0">Scanned Pages</h3>
      <div class="small" style="margin-bottom:8px">Tap a page to re-edit. Drag to reorder.</div>
      <div id="pageList" class="preview-list" aria-live="polite"></div>

      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn" id="saveProject">Save Project</button>
        <button class="btn" id="loadProject">Load Project</button>
        <button class="btn" id="clearAll">Clear</button>
      </div>
    </aside>
  </div>
</main>

<!-- Crop Modal -->
<div id="cropModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="small">Adjust corners & crop</div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="rotateLeft">⟲</button>
        <button class="btn" id="rotateRight">⟳</button>
        <button class="btn" id="confirmCrop">Confirm</button>
      </div>
    </div>
    <div class="img-wrap">
      <img id="cropImage" style="max-width:100%;display:block;margin:0 auto" alt="Crop preview">
    </div>
  </div>
</div>

<!-- Onboarding (mobile-only) -->
<div class="onboard" id="onboard" aria-hidden="true">
  <div class="onboard-overlay"></div>
  <div class="onboard-highlight" id="onboardHighlight" style="display:none"></div>
  <div class="onboard-tooltip" id="onboardTooltip" style="display:none">
    <div id="onboardText" style="font-weight:600;margin-bottom:8px">Welcome to PDF Chamber</div>
    <div id="onboardBody" style="font-size:.95rem;color:var(--text-secondary)">Tap to continue</div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
      <button class="btn" id="onboardNext">Next</button>
      <button class="btn" id="onboardSkip">Got it</button>
    </div>
  </div>
</div>

<footer>© 2025 PDF Chamber. All rights reserved.</footer>

<script>
/* -------------------------
   Globals & Elements
   ------------------------- */
const isMobile = (('maxTouchPoints' in navigator && navigator.maxTouchPoints>0) || /Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) && window.innerWidth <= 900;

const mobileScanner = document.getElementById('mobileScanner');
const desktopHint = document.getElementById('desktopHint');
const desktopPanel = document.getElementById('desktopPanel');
const themeToggle = document.getElementById('themeToggle');
const qrCanvas = document.getElementById('qrCanvas');
const copyLinkBtn = document.getElementById('copyLinkBtn');

const openCameraBtn = document.getElementById('openCameraBtn');
const captureBtn = document.getElementById('captureBtn');
const fileInput = document.getElementById('fileInput');
const uploadLabel = document.getElementById('uploadLabel');
const autoToggle = document.getElementById('autoToggle');

const brightness = document.getElementById('brightness');
const contrast = document.getElementById('contrast');

const filterBtns = document.querySelectorAll('.filter-btn');

const generatePdfBtn = document.getElementById('generatePdfBtn');
const downloadBtn = document.getElementById('downloadBtn');
const shareBtn = document.getElementById('shareBtn');

const pageList = document.getElementById('pageList');
const desktopDropArea = document.getElementById('desktopDropArea');

const saveProjectBtn = document.getElementById('saveProject');
const loadProjectBtn = document.getElementById('loadProject');
const clearAllBtn = document.getElementById('clearAll');

const cropModal = document.getElementById('cropModal');
const cropImage = document.getElementById('cropImage');
const confirmCropBtn = document.getElementById('confirmCrop');
const rotateLeftBtn = document.getElementById('rotateLeft');
const rotateRightBtn = document.getElementById('rotateRight');

const onboard = document.getElementById('onboard');
const onboardHighlight = document.getElementById('onboardHighlight');
const onboardTooltip = document.getElementById('onboardTooltip');
const onboardText = document.getElementById('onboardText');
const onboardBody = document.getElementById('onboardBody');
const onboardNext = document.getElementById('onboardNext');
const onboardSkip = document.getElementById('onboardSkip');

const cameraView = document.getElementById('cameraView');
const overlay = document.getElementById('overlay');

let stream = null;
let cvReady = false;
let processing = false;
let autoCapture = true;
let stabilityCounter = 0;
let lastContour = null;
let cropper = null;
let pages = []; // {canvas, dataUrl, width, height}
let lastPdfBlob = null;

/* theme toggle */
if(localStorage.theme==='dark' || (!localStorage.theme && window.matchMedia('(prefers-color-scheme:dark)').matches)){
  document.documentElement.dataset.theme='dark';
}
themeToggle.addEventListener('click', ()=>{
  document.documentElement.dataset.theme = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
  localStorage.theme = document.documentElement.dataset.theme;
});

/* show appropriate layout */
function applyLayout(){
  if(isMobile){
    mobileScanner.style.display='block';
    desktopHint.style.display='none';
    desktopPanel.style.display='none';
    startOnboardingIfNeeded();
  } else {
    mobileScanner.style.display='none';
    desktopHint.style.display='block';
    desktopPanel.style.display='block';
    generateQR(window.location.href);
  }
}
applyLayout();
window.addEventListener('resize', ()=> { /* layout adaptive */ });

/* QR generation (desktop) */
function generateQR(text){
  try {
    new QRious({ element: qrCanvas, value: text, size: 260, background: '#fff', foreground: '#000' });
    copyLinkBtn.onclick = async ()=> {
      try { await navigator.clipboard.writeText(text); alert('Link copied'); } catch(e){ prompt('Copy link', text); }
    };
  } catch(e){ console.warn('QR failed', e); }
}

/* -------------------------
   OpenCV init
   ------------------------- */
function onOpenCvReady(){ cvReady = true; console.log('OpenCV ready'); }
if(window.cv && cv['onRuntimeInitialized']) cv['onRuntimeInitialized'] = onOpenCvReady;

/* Resize overlay */
function resizeOverlay(){ if(cameraView) { overlay.width = cameraView.clientWidth; overlay.height = cameraView.clientHeight; overlay.style.left = cameraView.offsetLeft + 'px'; overlay.style.top = cameraView.offsetTop + 'px'; } }
window.addEventListener('resize', resizeOverlay);

/* -------------------------
   Camera & Edge Detection
   ------------------------- */
openCameraBtn.addEventListener('click', async ()=>{
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false });
    cameraView.srcObject = stream;
    await cameraView.play();
    resizeOverlay();
    captureBtn.disabled = false;
    startEdgeLoop();
  } catch(err){
    console.warn('getUserMedia failed', err);
    alert('Camera access failed: ' + err.message + '\nYou can use Choose Images as fallback.');
    fileInput.click();
  }
});

autoToggle.addEventListener('click', ()=>{
  autoCapture = !autoCapture;
  autoToggle.textContent = 'Auto-Capture: ' + (autoCapture ? 'On' : 'Off');
});

/* Edge detection loop */
function startEdgeLoop(){
  if(!cvReady) return;
  const smallW = 320, smallH = 240;
  const off = document.createElement('canvas'); off.width = smallW; off.height = smallH;
  const offCtx = off.getContext('2d');
  const ctx = overlay.getContext('2d');
  processing = false; stabilityCounter = 0; lastContour = null;

  (function loop(){
    if(!cameraView.videoWidth){ requestAnimationFrame(loop); return; }
    try {
      offCtx.drawImage(cameraView, 0, 0, smallW, smallH);
      let src = cv.imread(off);
      let gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
      cv.GaussianBlur(gray, gray, new cv.Size(5,5), 0);
      let edged = new cv.Mat(); cv.Canny(gray, edged, 75, 200);
      let contours = new cv.MatVector(); let hierarchy = new cv.Mat();
      cv.findContours(edged, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);
      let best=null, maxA=0;
      for(let i=0;i<contours.size();i++){
        const cnt = contours.get(i);
        const peri = cv.arcLength(cnt, true);
        const approx = new cv.Mat(); cv.approxPolyDP(cnt, approx, 0.02*peri, true);
        if(approx.rows===4){
          const area = cv.contourArea(cnt);
          if(area>maxA){ maxA = area; best = approx; }
        }
      }
      ctx.clearRect(0,0,overlay.width, overlay.height);
      if(best){
        const pts=[];
        for(let i=0;i<4;i++){
          pts.push({ x: best.data32S[i*2] * (overlay.width/smallW), y: best.data32S[i*2+1] * (overlay.height/smallH) });
        }
        drawPolygon(ctx, pts, '#00ff00');
        const polyStr = JSON.stringify(pts.map(p=>Math.round(p.x)+','+Math.round(p.y)));
        if(polyStr === lastContour) stabilityCounter++; else { stabilityCounter = 0; lastContour = polyStr; }
        if(autoCapture && stabilityCounter > 6 && !processing){
          processing = true;
          setTimeout(()=>{ captureFromVideo(); processing=false; }, 160);
        }
        best.delete();
      }
      src.delete(); gray.delete(); edged.delete(); contours.delete(); hierarchy.delete();
    } catch(err){ /* ignore */ }
    requestAnimationFrame(loop);
  })();
}

function drawPolygon(ctx, pts, color){
  ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
  ctx.closePath(); ctx.stroke(); ctx.fillStyle='rgba(0,255,0,0.06)'; ctx.fill();
}

/* -------------------------
   Capture & Auto-crop (full-res)
   ------------------------- */
async function captureFromVideo(){
  if(!cameraView.videoWidth) return;
  const canvas = document.createElement('canvas'); canvas.width = cameraView.videoWidth; canvas.height = cameraView.videoHeight;
  const cx = canvas.getContext('2d'); cx.drawImage(cameraView, 0, 0, canvas.width, canvas.height);

  if(cvReady){
    try {
      const src = cv.imread(canvas);
      let gray = new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY); cv.GaussianBlur(gray, gray, new cv.Size(5,5), 0);
      let edged = new cv.Mat(); cv.Canny(gray, edged, 75, 200);
      let contours = new cv.MatVector(); let hierarchy = new cv.Mat();
      cv.findContours(edged, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);
      let best=null, maxA=0;
      for(let i=0;i<contours.size();i++){
        const cnt = contours.get(i);
        const peri = cv.arcLength(cnt, true);
        const approx = new cv.Mat(); cv.approxPolyDP(cnt, approx, 0.02*peri, true);
        if(approx.rows===4){
          const area = cv.contourArea(cnt);
          if(area>maxA){ maxA = area; best = approx; }
        }
      }
      if(best){
        const pts=[]; for(let i=0;i<4;i++) pts.push({ x: best.data32S[i*2], y: best.data32S[i*2+1] });
        pts.sort((a,b)=>a.y-b.y);
        const top = pts.slice(0,2).sort((a,b)=>a.x-b.x);
        const bottom = pts.slice(2,4).sort((a,b)=>a.x-b.x);
        const ordered = [ top[0], top[1], bottom[1], bottom[0] ];
        const widthTop = Math.hypot(ordered[0].x-ordered[1].x, ordered[0].y-ordered[1].y);
        const widthBottom = Math.hypot(ordered[3].x-ordered[2].x, ordered[3].y-ordered[2].y);
        const maxW = Math.max(widthTop, widthBottom);
        const heightLeft = Math.hypot(ordered[0].x-ordered[3].x, ordered[0].y-ordered[3].y);
        const heightRight = Math.hypot(ordered[1].x-ordered[2].x, ordered[1].y-ordered[2].y);
        const maxH = Math.max(heightLeft, heightRight);

        const srcCoords = cv.matFromArray(4,1,cv.CV_32FC2,[ordered[0].x,ordered[0].y, ordered[1].x,ordered[1].y, ordered[2].x,ordered[2].y, ordered[3].x,ordered[3].y]);
        const dstCoords = cv.matFromArray(4,1,cv.CV_32FC2,[0,0, maxW-1,0, maxW-1,maxH-1, 0,maxH-1]);
        const M = cv.getPerspectiveTransform(srcCoords, dstCoords);
        const dst = new cv.Mat(); const dsize = new cv.Size(Math.round(maxW), Math.round(maxH));
        cv.warpPerspective(src, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
        const outCanvas = document.createElement('canvas'); outCanvas.width = dst.cols; outCanvas.height = dst.rows;
        cv.imshow(outCanvas, dst);
        openCropModal(outCanvas.toDataURL('image/jpeg'));
        src.delete(); gray.delete(); edged.delete(); contours.delete(); hierarchy.delete(); if(best) best.delete();
        srcCoords.delete(); dstCoords.delete(); M.delete(); dst.delete();
        return;
      }
      src.delete(); gray.delete(); edged.delete(); contours.delete(); hierarchy.delete();
    } catch(err){
      console.warn('auto-crop error', err);
    }
  }
  openCropModal(canvas.toDataURL('image/jpeg'));
}

/* -------------------------
   Crop modal: Cropper.js
   ------------------------- */
function openCropModal(dataUrl){
  cropImage.src = dataUrl;
  cropModal.classList.add('show');
  setTimeout(()=>{ if(cropper) cropper.destroy(); cropper = new Cropper(cropImage, { viewMode:1, autoCropArea:1, movable:true, zoomable:true, rotatable:true }); }, 150);
}

confirmCropBtn.addEventListener('click', async ()=>{
  if(!cropper) return;
  const cropped = cropper.getCroppedCanvas();
  const processed = await applyEnhancementsToCanvas(cropped);
  pages.push({ canvas: processed, dataUrl: processed.toDataURL('image/jpeg',0.95), width: processed.width, height: processed.height });
  renderPages();
  cropModal.classList.remove('show');
  cropper.destroy(); cropper = null;
  generatePdfBtn.disabled = false;
});

rotateLeftBtn.addEventListener('click', ()=> { if(cropper) cropper.rotate(-90); });
rotateRightBtn.addEventListener('click', ()=> { if(cropper) cropper.rotate(90); });

cropModal.addEventListener('click', (e)=>{ if(e.target === cropModal){ cropModal.classList.remove('show'); if(cropper){ cropper.destroy(); cropper=null; } } });

/* -------------------------
   Image Upload (mobile gallery & desktop drag-drop)
   ------------------------- */
fileInput.addEventListener('change', async (e)=>{
  const files = Array.from(e.target.files || []);
  for(const f of files){
    const url = URL.createObjectURL(f);
    await handleImageUpload(url);
    URL.revokeObjectURL(url);
  }
});

/* Desktop drag & drop (QR panel area) */
if(desktopDropArea){
  ['dragenter','dragover'].forEach(ev=> desktopDropArea.addEventListener(ev,e=>{ e.preventDefault(); desktopDropArea.style.opacity='0.9'; }));
  ['dragleave','drop'].forEach(ev=> desktopDropArea.addEventListener(ev,e=>{ e.preventDefault(); desktopDropArea.style.opacity='1'; }));
  desktopDropArea.addEventListener('drop', async (e)=> {
    const files = Array.from(e.dataTransfer.files || []).filter(f=>f.type.startsWith('image/'));
    for(const f of files){
      const url = URL.createObjectURL(f);
      await handleImageUpload(url);
      URL.revokeObjectURL(url);
    }
  });
}

/* handleImageUpload - attempts auto-crop via OpenCV, otherwise open crop modal */
async function handleImageUpload(url){
  const img = new Image(); img.crossOrigin='anonymous'; img.src = url; await new Promise(r=>img.onload=r);
  const c = document.createElement('canvas'); c.width = img.naturalWidth; c.height = img.naturalHeight; c.getContext('2d').drawImage(img,0,0);
  if(cvReady){
    try {
      const src = cv.imread(c); let gray=new cv.Mat(); cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY); cv.GaussianBlur(gray, gray, new cv.Size(5,5), 0);
      let edged = new cv.Mat(); cv.Canny(gray, edged, 75, 200);
      let contours = new cv.MatVector(); let hierarchy = new cv.Mat();
      cv.findContours(edged, contours, hierarchy, cv.RETR_LIST, cv.CHAIN_APPROX_SIMPLE);
      let best=null, maxA=0;
      for(let i=0;i<contours.size();i++){
        const cnt = contours.get(i); const peri = cv.arcLength(cnt,true); const approx = new cv.Mat(); cv.approxPolyDP(cnt,approx,0.02*peri,true);
        if(approx.rows===4){ const area = cv.contourArea(cnt); if(area>maxA){ maxA=area; best=approx; } }
      }
      if(best){
        const pts=[]; for(let i=0;i<4;i++) pts.push({x:best.data32S[i*2], y:best.data32S[i*2+1]});
        pts.sort((a,b)=>a.y-b.y); const top=pts.slice(0,2).sort((a,b)=>a.x-b.x); const bottom=pts.slice(2,4).sort((a,b)=>a.x-b.x);
        const ordered=[top[0],top[1],bottom[1],bottom[0]];
        const widthTop=Math.hypot(ordered[0].x-ordered[1].x, ordered[0].y-ordered[1].y);
        const widthBottom=Math.hypot(ordered[3].x-ordered[2].x, ordered[3].y-ordered[2].y);
        const maxW=Math.max(widthTop,widthBottom);
        const heightLeft=Math.hypot(ordered[0].x-ordered[3].x, ordered[0].y-ordered[3].y);
        const heightRight=Math.hypot(ordered[1].x-ordered[2].x, ordered[1].y-ordered[2].y);
        const maxH=Math.max(heightLeft,heightRight);
        const srcCoords = cv.matFromArray(4,1,cv.CV_32FC2,[ordered[0].x,ordered[0].y, ordered[1].x,ordered[1].y, ordered[2].x,ordered[2].y, ordered[3].x,ordered[3].y]);
        const dstCoords = cv.matFromArray(4,1,cv.CV_32FC2,[0,0, maxW-1,0, maxW-1,maxH-1, 0,maxH-1]);
        const M = cv.getPerspectiveTransform(srcCoords, dstCoords); const dst = new cv.Mat(); const dsize = new cv.Size(Math.round(maxW), Math.round(maxH));
        cv.warpPerspective(src, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
        const outCanvas = document.createElement('canvas'); outCanvas.width = dst.cols; outCanvas.height = dst.rows; cv.imshow(outCanvas, dst);
        openCropModal(outCanvas.toDataURL('image/jpeg'));
        src.delete(); gray.delete(); edged.delete(); contours.delete(); hierarchy.delete(); if(best) best.delete(); srcCoords.delete(); dstCoords.delete(); M.delete(); dst.delete();
        return;
      }
      src.delete(); gray.delete(); edged.delete(); contours.delete(); hierarchy.delete();
    } catch(err){ console.warn('upload auto-crop failed', err); }
  }
  openCropModal(c.toDataURL('image/jpeg'));
}

/* -------------------------
   Filters & adjustments
   ------------------------- */
function applyFilterToCanvas(srcCanvas, filter){
  const tmp = document.createElement('canvas'); tmp.width = srcCanvas.width; tmp.height = srcCanvas.height;
  const ctx = tmp.getContext('2d'); ctx.drawImage(srcCanvas,0,0);
  if(filter === 'original') return tmp;
  const imgd = ctx.getImageData(0,0,tmp.width,tmp.height); const d = imgd.data;
  if(filter === 'gray'){
    for(let i=0;i<d.length;i+=4){ const v = 0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; d[i]=d[i+1]=d[i+2]=v; }
  } else if(filter === 'bw'){
    for(let i=0;i<d.length;i+=4){ const v = 0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; d[i]=d[i+1]=d[i+2]= (v>140?255:0); }
  } else if(filter === 'auto'){
    for(let i=0;i<d.length;i+=4){ d[i] = Math.min(255, (d[i]-128)*1.06 + 128); d[i+1] = Math.min(255, (d[i+1]-128)*1.06 + 128); d[i+2] = Math.min(255, (d[i+2]-128)*1.06 + 128); }
  } else if(filter === 'light'){
    for(let i=0;i<d.length;i+=4){ const v = 0.299*d[i]+0.587*d[i+1]+0.114*d[i+2]; d[i]=d[i+1]=d[i+2]=Math.min(255,v*1.12); }
  }
  ctx.putImageData(imgd,0,0);
  return tmp;
}

async function applyEnhancementsToCanvas(srcCanvas){
  const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'original';
  let tmp = (activeFilter === 'original') ? srcCanvas : applyFilterToCanvas(srcCanvas, activeFilter);
  const bright = parseInt(brightness.value)/100;
  const cont = parseInt(contrast.value)/100;
  if(bright !== 1 || cont !== 1){
    const ctx = tmp.getContext('2d'); const imgd = ctx.getImageData(0,0,tmp.width,tmp.height); const d = imgd.data;
    for(let i=0;i<d.length;i+=4){
      let r=d[i], g=d[i+1], b=d[i+2];
      r = (r-128)*cont + 128; g = (g-128)*cont + 128; b = (b-128)*cont + 128;
      r *= bright; g *= bright; b *= bright;
      d[i]=Math.max(0,Math.min(255,Math.round(r))); d[i+1]=Math.max(0,Math.min(255,Math.round(g))); d[i+2]=Math.max(0,Math.min(255,Math.round(b)));
    }
    ctx.putImageData(imgd,0,0);
  }
  return tmp;
}

/* -------------------------
   Pages list & Sortable
   ------------------------- */
function renderPages(){
  pageList.innerHTML = '';
  pages.forEach((p,i)=>{
    const div = document.createElement('div'); div.className='thumb'; div.dataset.index = i;
    const canvas = document.createElement('canvas'); canvas.width = p.width; canvas.height = p.height; canvas.getContext('2d').drawImage(p.canvas,0,0);
    canvas.style.width='120px';
    const meta = document.createElement('div'); meta.className='meta'; meta.innerHTML = `<div style="font-weight:600">Page ${i+1}</div><div style="font-size:12px;color:var(--text-secondary)">${p.width}×${p.height}</div>`;
    const actions = document.createElement('div'); actions.style.marginLeft='auto'; actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='6px';
    const edit = document.createElement('button'); edit.className='btn'; edit.textContent='Edit'; edit.addEventListener('click', ()=> openCropModal(p.dataUrl));
    const del = document.createElement('button'); del.className='btn'; del.textContent='Delete'; del.addEventListener('click', ()=> { pages.splice(i,1); renderPages(); });
    actions.appendChild(edit); actions.appendChild(del);
    div.appendChild(canvas); div.appendChild(meta); div.appendChild(actions);
    pageList.appendChild(div);
  });
  Sortable.create(pageList, { animation:150, onEnd: (evt)=>{ const item = pages.splice(evt.oldIndex,1)[0]; pages.splice(evt.newIndex,0,item); renderPages(); }});
}

/* -------------------------
   Generate PDF & Share
   ------------------------- */
async function generatePDF({ download=true } = { download:true }){
  if(pages.length===0) return alert('Add scanned pages first');
  generatePdfBtn.textContent='Generating…';
  const pdfDoc = await PDFLib.PDFDocument.create();
  for(const p of pages){
    const jpgBytes = await (await fetch(p.dataUrl)).arrayBuffer();
    const img = await pdfDoc.embedJpg(jpgBytes);
    const page = pdfDoc.addPage([p.width, p.height]);
    page.drawImage(img, { x:0, y:0, width:p.width, height:p.height });
  }
  const pdfBytes = await pdfDoc.save();
  lastPdfBlob = new Blob([pdfBytes], { type: 'application/pdf' });
  generatePdfBtn.textContent='Generate PDF';
  downloadBtn.disabled = false; shareBtn.disabled = false;
  if(download){
    const url = URL.createObjectURL(lastPdfBlob);
    const a = document.createElement('a'); a.href = url; a.download = `scanned-${new Date().toISOString().slice(0,10)}.pdf`; a.click();
    setTimeout(()=>URL.revokeObjectURL(url),2000);
  }
  return lastPdfBlob;
}

generatePdfBtn.addEventListener('click', ()=> generatePDF({ download:true }));
downloadBtn.addEventListener('click', ()=> {
  if(!lastPdfBlob) return alert('Generate PDF first');
  const url = URL.createObjectURL(lastPdfBlob);
  const a = document.createElement('a'); a.href = url; a.download = `scanned-${new Date().toISOString().slice(0,10)}.pdf`; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),2000);
});

async function sharePdf(){
  if(!lastPdfBlob) await generatePDF({ download:false });
  if(!lastPdfBlob) return alert('PDF creation failed');
  try {
    const file = new File([lastPdfBlob], `scanned-${new Date().toISOString().slice(0,10)}.pdf`, { type:'application/pdf' });
    if(navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({ files: [file], title: 'Scanned PDF', text: 'Scanned with PDF Chamber' });
    } else if(navigator.share){
      const url = URL.createObjectURL(lastPdfBlob);
      await navigator.share({ title:'Scanned PDF', text:'Scanned document', url });
      setTimeout(()=>URL.revokeObjectURL(url),2000);
    } else {
      const url = URL.createObjectURL(lastPdfBlob); const a = document.createElement('a'); a.href = url; a.download = file.name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000);
    }
  } catch(err){
    console.error('share failed', err);
    alert('Share failed — downloaded file instead.');
    const url = URL.createObjectURL(lastPdfBlob); const a = document.createElement('a'); a.href = url; a.download = `scanned-${new Date().toISOString().slice(0,10)}.pdf`; a.click(); setTimeout(()=>URL.revokeObjectURL(url),2000);
  }
}
shareBtn.addEventListener('click', sharePdf);

/* -------------------------
   Save / Load / Clear project
   ------------------------- */
saveProjectBtn.addEventListener('click', ()=> {
  const toSave = pages.map(p=>({ dataUrl: p.dataUrl, width:p.width, height:p.height }));
  localStorage.setItem('scanProjectV2', JSON.stringify(toSave));
  alert('Project saved locally');
});
loadProjectBtn.addEventListener('click', async ()=> {
  const raw = localStorage.getItem('scanProjectV2'); if(!raw) return alert('No project saved');
  const arr = JSON.parse(raw); pages = [];
  for(const it of arr){
    const img = new Image(); img.src = it.dataUrl; await new Promise(r=>img.onload=r);
    const c = document.createElement('canvas'); c.width = it.width; c.height = it.height; c.getContext('2d').drawImage(img,0,0);
    pages.push({ canvas: c, dataUrl: it.dataUrl, width: it.width, height: it.height });
  }
  renderPages();
  generatePdfBtn.disabled = false;
});
clearAllBtn.addEventListener('click', ()=> { pages=[]; renderPages(); generatePdfBtn.disabled=true; downloadBtn.disabled=true; shareBtn.disabled=true; lastPdfBlob=null; });

/* -------------------------
   Filter button wiring
   ------------------------- */
filterBtns.forEach(btn=> btn.addEventListener('click', ()=> {
  filterBtns.forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}));

/* -------------------------
   Onboarding (mobile-only) — Adobe-style
   ------------------------- */
const ONBOARD_KEY = 'scan_onboarded_v1';
const onboardingSteps = [
  { el: '#openCameraBtn', title: 'Open Camera', text: 'Tap here to open your rear camera and scan documents hands-free.' },
  { el: '#uploadLabel', title: 'Choose Images', text: 'Tap here to pick photos from your gallery instead.' },
  { el: '#generatePdfBtn', title: 'Generate PDF', text: 'When you are done scanning, tap here to create a PDF.' },
  { el: '#shareBtn', title: 'Share PDF', text: 'Use this to share your scanned PDF with others.' }
];
let onboardIndex = 0;

function startOnboardingIfNeeded(){
  try {
    if(!isMobile) return;
    if(localStorage.getItem(ONBOARD_KEY)) return;
    showOnboardStep(0);
    onboard.classList.add('active');
    onboardTooltip.style.display='block';
    onboardHighlight.style.display='block';
  } catch(e){ console.warn('onboarding error', e); }
}

function showOnboardStep(i){
  onboardIndex = i;
  const step = onboardingSteps[i];
  const target = document.querySelector(step.el);
  if(!target) return;
  const rect = target.getBoundingClientRect();
  const pad = 12;
  onboardHighlight.style.width = (rect.width + pad*2) + 'px';
  onboardHighlight.style.height = (rect.height + pad*2) + 'px';
  onboardHighlight.style.left = (rect.left - pad) + 'px';
  onboardHighlight.style.top = (rect.top - pad) + 'px';
  const ttW = 300;
  const left = Math.min(window.innerWidth - ttW - 12, Math.max(12, rect.left));
  let top = rect.bottom + pad + 8;
  if(top + 140 > window.innerHeight) top = rect.top - 140 - pad;
  onboardTooltip.style.left = left + 'px';
  onboardTooltip.style.top = top + 'px';
  onboardText.textContent = step.title;
  onboardBody.textContent = step.text;
  onboard.classList.add('active');
  onboardTooltip.style.display='block';
  onboardHighlight.style.display='block';
}

onboardNext.addEventListener('click', ()=>{
  onboardIndex++;
  if(onboardIndex < onboardingSteps.length) showOnboardStep(onboardIndex);
  else finishOnboarding();
});
onboardSkip.addEventListener('click', finishOnboarding);

function finishOnboarding(){
  onboard.classList.remove('active');
  onboardTooltip.style.display='none';
  onboardHighlight.style.display='none';
  localStorage.setItem(ONBOARD_KEY, '1');
}

/* -------------------------
   On load: init UI & listeners
   ------------------------- */
window.addEventListener('load', ()=>{
  applyLayout();
  // If drag-drop area exists, hook global drop (so right panel + left upload-area accept drops)
  const dropTargets = Array.from(document.querySelectorAll('.upload-area'));
  dropTargets.push(desktopDropArea);
  dropTargets.forEach(el=>{
    if(!el) return;
    ['dragenter','dragover'].forEach(ev=> el.addEventListener(ev, e=> { e.preventDefault(); el.style.opacity='0.9'; }));
    ['dragleave','drop'].forEach(ev=> el.addEventListener(ev, e=> { e.preventDefault(); el.style.opacity='1'; }));
    el.addEventListener('drop', async (e)=> {
      const files = Array.from(e.dataTransfer.files || []).filter(f=>f.type.startsWith('image/'));
      for(const f of files){
        const url = URL.createObjectURL(f);
        await handleImageUpload(url);
        URL.revokeObjectURL(url);
      }
    });
  });
});

/* End of script */
</script>
</body>
</html>
